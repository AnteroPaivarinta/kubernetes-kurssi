app.get("/page", (req, res) => {
  let dataURL = "";

  if (fs.existsSync("public/image_old.jpg")) {
    const kuvaBuffer = fs.readFileSync("public/image_old.jpg");
    const kuvaBase64 = kuvaBuffer.toString("base64");
    dataURL = `data:image/jpeg;base64,${kuvaBase64}`;
    fs.rm('public/image_old.jpg', { force: true }, (err) => {
      if (err) console.error(err);
    });
  } else {
    dataURL = "image.jpg";
  }

  res.send(`
    <html>
      <head>
        <title>Testisivu</title>
        <style>
          body { font-family: sans-serif; }
          li { margin: 4px 0; }
        </style>
      </head>
      <body>
        <h1>Hello World!</h1>
        <img src="${dataURL}" alt="Satunnainen kuva" width="400" />

        <h2>Todo List</h2>
        <ul id="todoList"></ul>

        <form id="todoForm">
          <input type="text" id="todoInput" maxlength="140" placeholder="Write a todo" />
          <button type="submit">Add</button>
        </form>

        <script>
          const list = document.getElementById('todoList');
          const form = document.getElementById('todoForm');
          const input = document.getElementById('todoInput');
          const STORAGE_KEY = "todos";

          // hae tallennetut todos
          let todos = JSON.parse(localStorage.getItem(STORAGE_KEY)) || ["Buy groceries", "Call mom", "Finish project"];

          function renderTodos() {
            list.innerHTML = todos.map(t => "<li>" + t + "</li>").join("");
          }

          form.addEventListener('submit', (e) => {
            e.preventDefault(); // estä lomakkeen lähetys
            const value = input.value.trim();
            if (value && value.length <= 140) {
              todos.push(value);
              localStorage.setItem(STORAGE_KEY, JSON.stringify(todos));
              renderTodos();
              input.value = "";
            }
          });

          renderTodos();
        </script>
      </body>
    </html>
  `);
});
